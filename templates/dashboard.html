{% extends "base.html" %}

{% block header %}Overview{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Stat Card 1: Documents -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-sm font-medium text-gray-500">Total Documents</p>
                <h3 class="text-3xl font-bold text-gray-900 mt-2">{{ stats.total_docs }}</h3>
            </div>
            <div class="p-3 bg-blue-50 rounded-lg text-blue-600">
                <i class="fa-solid fa-file-lines text-xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm text-blue-600">
            <a href="/documents" class="hover:underline">View all <i class="fa-solid fa-arrow-right ml-1"></i></a>
        </div>
    </div>

    <!-- Stat Card 2: Search Queries -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-sm font-medium text-gray-500">Total Searches</p>
                <h3 class="text-3xl font-bold text-gray-900 mt-2">{{ stats.analytics.get('search', {}).get('total_searches', 0) }}</h3>
            </div>
            <div class="p-3 bg-purple-50 rounded-lg text-purple-600">
                <i class="fa-solid fa-magnifying-glass text-xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm text-gray-500">
            {% if stats.analytics.get('search', {}).get('avg_latency_ms') %}
            <span>Avg latency: {{ stats.analytics.search.avg_latency_ms }}ms</span>
            {% else %}
            <span>No searches yet</span>
            {% endif %}
        </div>
    </div>

    <!-- Stat Card 3: System Health -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-sm font-medium text-gray-500">System Status</p>
                {% if stats.health.get('status') == 'ready' %}
                <h3 class="text-2xl font-bold text-green-600 mt-2">All Systems Go</h3>
                {% elif stats.health.get('error') %}
                <h3 class="text-2xl font-bold text-red-600 mt-2">Backend Offline</h3>
                {% else %}
                <h3 class="text-2xl font-bold text-yellow-600 mt-2">{{ stats.health.get('status', 'Unknown') | title }}</h3>
                {% endif %}
            </div>
            <div class="p-3 {% if stats.health.get('status') == 'ready' %}bg-green-50 text-green-600{% else %}bg-red-50 text-red-600{% endif %} rounded-lg">
                <i class="fa-solid fa-server text-xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
            {% if stats.health.get('checks') %}
                {% for service, status in stats.health.checks.items() %}
                <span class="mr-3 {% if status == 'connected' %}text-green-600{% else %}text-red-500{% endif %}">
                    <i class="fa-solid {% if status == 'connected' %}fa-check-circle{% else %}fa-times-circle{% endif %} mr-1"></i>{{ service }}
                </span>
                {% endfor %}
            {% elif stats.health.get('error') %}
                <span class="text-red-500"><i class="fa-solid fa-times-circle mr-1"></i>{{ stats.health.error }}</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- RAG Stats -->
{% if stats.analytics.get('rag') %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">RAG Q&A Stats</h3>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-500">Total Queries</span>
                <span class="font-medium">{{ stats.analytics.rag.total_queries }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Avg Latency</span>
                <span class="font-medium">{{ stats.analytics.rag.avg_latency_ms }}ms</span>
            </div>
            {% if stats.analytics.rag.get('confidence_distribution') %}
            <div class="pt-2 border-t border-gray-100">
                <p class="text-sm text-gray-500 mb-2">Confidence Distribution</p>
                <div class="flex gap-3">
                    <span class="text-green-600 text-sm"><i class="fa-solid fa-circle text-xs mr-1"></i>High: {{ stats.analytics.rag.confidence_distribution.get('high', 0) }}</span>
                    <span class="text-yellow-600 text-sm"><i class="fa-solid fa-circle text-xs mr-1"></i>Medium: {{ stats.analytics.rag.confidence_distribution.get('medium', 0) }}</span>
                    <span class="text-red-600 text-sm"><i class="fa-solid fa-circle text-xs mr-1"></i>Low: {{ stats.analytics.rag.confidence_distribution.get('low', 0) }}</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Popular Documents -->
    {% if stats.analytics.get('popular_documents') %}
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">Most Accessed Documents</h3>
        <div class="space-y-2">
            {% for doc in stats.analytics.popular_documents[:5] %}
            <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600 truncate">{{ doc.document_id[:8] }}...</span>
                <span class="text-gray-900 font-medium">{{ doc.access_count }} views</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Recent Documents Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="font-semibold text-gray-800">Recent Documents</h3>
        <a href="/documents" class="text-sm text-blue-600 hover:text-blue-700 font-medium">View All</a>
    </div>
    {% if stats.recent_docs %}
    <table class="w-full">
        <thead class="bg-gray-50 text-xs uppercase text-gray-500">
            <tr>
                <th class="px-6 py-3 text-left">Filename</th>
                <th class="px-6 py-3 text-left">Status</th>
                <th class="px-6 py-3 text-left">Size</th>
                <th class="px-6 py-3 text-left">Uploaded</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for doc in stats.recent_docs %}
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-3">
                    <a href="/documents/{{ doc.id or doc.document_id }}" class="text-blue-600 hover:underline font-medium">
                        {{ doc.original_filename or doc.filename or 'Unknown' }}
                    </a>
                </td>
                <td class="px-6 py-3">
                    <span class="px-2 py-1 rounded-full text-xs font-medium
                        {% if doc.status == 'completed' %}bg-green-100 text-green-700
                        {% elif doc.status == 'processing' %}bg-yellow-100 text-yellow-700
                        {% elif doc.status == 'failed' %}bg-red-100 text-red-700
                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                        {{ doc.status or 'pending' }}
                    </span>
                </td>
                <td class="px-6 py-3 text-sm text-gray-500">{{ (doc.file_size_bytes or doc.file_size) | filesize if (doc.file_size_bytes or doc.file_size) else '-' }}</td>
                <td class="px-6 py-3 text-sm text-gray-500">{{ doc.created_at | datetime if doc.created_at else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="px-6 py-12 text-center text-gray-400">
        <i class="fa-solid fa-folder-open text-4xl mb-3"></i>
        <p>No documents yet. <a href="/documents" class="text-blue-600 hover:underline">Upload your first document</a>.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
