{% extends "base.html" %}

{% block header %}Agent Workflows{% endblock %}

{% block content %}
<div x-data="agentApp()" class="flex flex-col h-full">
    
    <!-- Workflow Selection Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
        {% for key, workflow in workflows.items() %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow cursor-pointer relative overflow-hidden group"
             @click="selectWorkflow('{{ key }}', '{{ workflow.description }}', {{ workflow.required_params | tojson }})">
            
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fa-solid fa-robot text-6xl text-blue-600"></i>
            </div>

            <div class="relative z-10">
                <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 mb-4">
                    <i class="fa-solid fa-bolt text-xl"></i>
                </div>
                <h3 class="font-bold text-gray-900 text-lg mb-2">{{ key|replace('_', ' ')|title }}</h3>
                <p class="text-sm text-gray-500 line-clamp-3">{{ workflow.description }}</p>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                <span class="text-xs font-medium text-gray-400 uppercase">ReAct Agent</span>
                <span class="text-blue-600 text-sm font-medium group-hover:translate-x-1 transition-transform">Run <i class="fa-solid fa-arrow-right ml-1"></i></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Active Workflow Interface (Modal/Panel) -->
    <div x-show="activeWorkflow" x-transition class="bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col flex-1 overflow-hidden">
        
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" x-show="isRunning"></div>
                <h2 class="font-bold text-gray-800" x-text="activeWorkflowTitle"></h2>
            </div>
            <button @click="activeWorkflow = null" class="text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <!-- Configuration Sidebar -->
            <div class="w-1/3 border-r border-gray-100 p-6 overflow-y-auto bg-white">
                <p class="text-sm text-gray-500 mb-6" x-text="activeWorkflowDesc"></p>
                
                <form @submit.prevent="runAgent">
                    <template x-for="param in activeParams" :key="param">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1" x-text="formatParam(param)"></label>
                            <input type="text" x-model="formData[param]" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                   :placeholder="'Enter ' + formatParam(param)">
                        </div>
                    </template>
                    
                    <button type="submit" 
                            :disabled="isRunning"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-play" x-show="!isRunning"></i>
                        <i class="fa-solid fa-circle-notch fa-spin" x-show="isRunning"></i>
                        <span x-text="isRunning ? 'Agent Running...' : 'Start Workflow'"></span>
                    </button>
                </form>
            </div>

            <!-- Execution Output -->
            <div class="w-2/3 bg-slate-900 p-6 overflow-y-auto font-mono text-sm flex flex-col">
                <!-- Empty State -->
                <div x-show="logs.length === 0" class="flex-1 flex flex-col items-center justify-center text-slate-600">
                    <i class="fa-solid fa-terminal text-4xl mb-4"></i>
                    <p>Ready to execute. Configure parameters and run.</p>
                </div>

                <!-- Logs -->
                <div class="space-y-4">
                    <template x-for="log in logs" :key="log.id">
                        <div class="animate-fade-in-up">
                            <!-- Reasoning Step -->
                            <template x-if="log.type === 'reasoning'">
                                <div class="flex gap-3 text-slate-300">
                                    <span class="text-yellow-500 mt-1"><i class="fa-solid fa-lightbulb"></i></span>
                                    <div>
                                        <span class="font-bold text-yellow-500">Thinking:</span>
                                        <span x-text="log.content"></span>
                                    </div>
                                </div>
                            </template>

                            <!-- Tool Call -->
                            <template x-if="log.type === 'tool_call'">
                                <div class="flex gap-3 text-slate-300 ml-4 border-l-2 border-slate-700 pl-4 py-1">
                                    <span class="text-blue-400 mt-1"><i class="fa-solid fa-screwdriver-wrench"></i></span>
                                    <div>
                                        <span class="font-bold text-blue-400">Action:</span>
                                        <span x-text="log.tool_name"></span>
                                        <span class="text-slate-500 text-xs block" x-text="JSON.stringify(log.tool_args)"></span>
                                    </div>
                                </div>
                            </template>

                            <!-- Tool Result -->
                            <template x-if="log.type === 'tool_result'">
                                <div class="flex gap-3 text-slate-400 ml-4 border-l-2 border-green-900 pl-4 py-1 mb-2">
                                    <span class="text-green-500 mt-1"><i class="fa-solid fa-check"></i></span>
                                    <div>
                                        <span class="font-bold text-green-500">Observation:</span>
                                        <span class="line-clamp-3 hover:line-clamp-none cursor-pointer" x-text="log.content"></span>
                                    </div>
                                </div>
                            </template>

                            <!-- Final Answer -->
                            <template x-if="log.type === 'result'">
                                <div class="mt-6 bg-slate-800 rounded-lg p-4 border border-slate-700">
                                    <div class="flex items-center gap-2 text-green-400 font-bold mb-2 border-b border-slate-700 pb-2">
                                        <i class="fa-solid fa-flag-checkered"></i> Final Answer
                                    </div>
                                    <div class="prose prose-invert max-w-none whitespace-pre-wrap text-slate-200" x-html="renderMarkdown(log.content)"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
function agentApp() {
    return {
        activeWorkflow: null,
        activeWorkflowTitle: '',
        activeWorkflowDesc: '',
        activeParams: [],
        formData: {},
        logs: [],
        isRunning: false,

        selectWorkflow(key, desc, params) {
            this.activeWorkflow = key;
            this.activeWorkflowTitle = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            this.activeWorkflowDesc = desc;
            this.activeParams = params;
            this.formData = {};
            this.logs = [];
            this.isRunning = false;
        },

        formatParam(param) {
            return param.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        },

        renderMarkdown(content) {
            const markdown = marked.parse(content || '');
            return DOMPurify.sanitize(markdown);
        },

        async runAgent() {
            this.isRunning = true;
            this.logs = [];
            
            const response = await fetch(`/api/run_agent_stream/${this.activeWorkflow}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ params: this.formData })
            });

            if (!response.ok || !response.body) {
                this.isRunning = false;
                this.logs.push({
                    id: Date.now(),
                    type: 'result',
                    content: 'Failed to start workflow stream.'
                });
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const events = buffer.split('\n\n');
                buffer = events.pop() || '';
                
                events.forEach(eventText => {
                    const line = eventText.trim();
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            
                            if (data.type === 'step') {
                                const step = data.content;
                                this.logs.push({
                                    id: Date.now() + Math.random(),
                                    type: step.step_type,
                                    content: step.content,
                                    tool_name: step.tool_name,
                                    tool_args: step.tool_args
                                });
                            } else if (data.type === 'result') {
                                this.logs.push({
                                    id: Date.now(),
                                    type: 'result',
                                    content: data.content
                                });
                            } else if (data.type === 'done') {
                                this.isRunning = false;
                            }
                            
                            // Auto scroll
                            this.$nextTick(() => {
                                const container = document.querySelector('.w-2\\/3');
                                if(container) container.scrollTop = container.scrollHeight;
                            });

                        } catch (e) { console.error(e); }
                    }
                });
            }

            const pending = buffer.trim();
            if (pending.startsWith('data: ')) {
                try {
                    const data = JSON.parse(pending.substring(6));
                    if (data.type === 'result') {
                        this.logs.push({
                            id: Date.now(),
                            type: 'result',
                            content: data.content
                        });
                    } else if (data.type === 'done') {
                        this.isRunning = false;
                    }
                } catch (e) { console.error(e); }
            }
            this.isRunning = false;
        }
    }
}
</script>
{% endblock %}
